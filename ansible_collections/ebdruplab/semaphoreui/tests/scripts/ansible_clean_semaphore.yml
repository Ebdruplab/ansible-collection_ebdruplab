# ansible-playbook -i {inventory,} ansible_clean_semaphore.yml
---
- name: Clean Semaphore and create integration test project
  hosts: localhost
  gather_facts: false
  vars:
    semaphore_host: "http://localhost"
    semaphore_port: 3000
    semaphore_username: "{{ lookup('env', 'ebdruplab_integration_test_USER') | default('admin', true) }}"
    semaphore_password: "{{ lookup('env', 'ebdruplab_integration_test_PW') | default('changeme', true) }}"
    new_project_name: "ebdruplab integration test"
  tasks:
    - name: Log in to Semaphore
      ebdruplab.semaphoreui.login:
        host: "{{ semaphore_host }}"
        port: "{{ semaphore_port }}"
        username: "{{ semaphore_username }}"
        password: "{{ semaphore_password }}"
      register: login_result

    - name: Get all projects
      ebdruplab.semaphoreui.project_list:
        host: "{{ semaphore_host }}"
        port: "{{ semaphore_port }}"
        session_cookie: "{{ login_result.session_cookie }}"
      register: project_list

    - name: Delete existing projects
      ebdruplab.semaphoreui.project_delete:
        host: "{{ semaphore_host }}"
        port: "{{ semaphore_port }}"
        session_cookie: "{{ login_result.session_cookie }}"
        project_id: "{{ item.id }}"
      loop: "{{ project_list.projects }}"
      loop_control:
        label: "{{ item.name }} (ID: {{ item.id }})"

    - name: Create new integration test project
      ebdruplab.semaphoreui.project_create:
        host: "{{ semaphore_host }}"
        port: "{{ semaphore_port }}"
        session_cookie: "{{ login_result.session_cookie }}"
        name: "{{ new_project_name }}"
        alert: true
        alert_chat: "Ansible"
        max_parallel_tasks: 5
        demo: false
      register: created_project

    - name: Show created project info
      ansible.builtin.debug:
        var: created_project.project

    - name: Log out
      ebdruplab.semaphoreui.logout:
        host: "{{ semaphore_host }}"
        port: "{{ semaphore_port }}"
        session_cookie: "{{ login_result.session_cookie }}"
