#SPDX-License-Identifier: MIT-0
---
- name: "Example Use"
  hosts: localhost
  gather_facts: true
  vars_files:
    - "vars/example_vars.yml"

  pre_tasks:
    - name: "Pre | Login"
      ebdruplab.semaphoreui.login:
        host: "{{ project_deploy_semaphore_host }}"
        port: "{{ project_deploy_semaphore_port }}"
        username: "{{ project_deploy_semaphore_username | default('admin') }}"
        password: "{{ project_deploy_semaphore_password | default('changeme') }}"
      register: login_result
      tags:
        - token
        - create
        - auth
        - login

    - name: "Generate API token and fact for role"
      block:
        - name: "Create API KEY"
          ebdruplab.semaphoreui.user_token_create:
            host: "{{ project_deploy_semaphore_host }}"
            port: "{{ project_deploy_semaphore_port }}"
            session_cookie: "{{ login_result.session_cookie }}"
          register: _api_key
          tags:
            - token
            - create
      always:
        - name: "Pre | Logout"
          ebdruplab.semaphoreui.logout:
            host: "{{ project_deploy_semaphore_host }}"
            port: "{{ project_deploy_semaphore_port }}"
            session_cookie: "{{ login_result.session_cookie }}"
          tags:
            - token
            - create
            - auth
            - logout

  roles:
    - name: "Import role: deploy_semaphore_mcp"
      role: ebdruplab.semaphoreui.deploy_semaphore_mcp
      vars:
        semaphore_mcp_api_token: "{{ _api_key.token.id }}"


  post_tasks:
    - name: "Post | Login"
      ebdruplab.semaphoreui.login:
        host: "{{ project_deploy_semaphore_host }}"
        port: "{{ project_deploy_semaphore_port }}"
        username: "{{ project_deploy_semaphore_username | default('admin') }}"
        password: "{{ project_deploy_semaphore_password | default('changeme') }}"
      register: login_result
      tags:
        - users
        - auth
        - login

    - name: "Reconcile Service Desk User"
      block:
        - name: "Delete API KEY"
          ebdruplab.semaphoreui.user_token_delete:
            host: "{{ project_deploy_semaphore_host }}"
            port: "{{ project_deploy_semaphore_port }}"
            session_cookie: "{{ login_result.session_cookie }}"
            api_token_id: "{{ _api_key.token.id }}"
          when: semaphore_mcp_cleanup_api_key
          tags:
            - token
            - delete

      always:
        - name: "Post | Logout"
          ebdruplab.semaphoreui.logout:
            host: "{{ project_deploy_semaphore_host }}"
            port: "{{ project_deploy_semaphore_port }}"
            session_cookie: "{{ login_result.session_cookie }}"
          tags:
            - token
            - delete
            - auth
            - logout
